name: Docker Build and Push

on:
  workflow_dispatch:  # ‰ªÖÊâãÂä®Ëß¶Âèë

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: ro  # üîπ ÈïúÂÉèÂêçÂèòÈáèÔºå‰øÆÊîπËøôÈáåÂç≥ÂèØ

    steps:
      # 1Ô∏è‚É£ Ê£ÄÂá∫‰ª£Á†Å
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ ËÆæÁΩÆÁâàÊú¨Âè∑
      - name: Set version tags
        id: vars
        run: |
          DATE_TAG=$(date +'%Y%m%d')
          SHA_TAG=$(git rev-parse --short HEAD)
          echo "VERSION_DATE=v$DATE_TAG" >> $GITHUB_ENV
          echo "VERSION_SHA=sha-$SHA_TAG" >> $GITHUB_ENV

      # 3Ô∏è‚É£ ÁôªÂΩï GHCR
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: Jonney111
          password: ${{ secrets.PAT_TOKEN }}

      # 4Ô∏è‚É£ ÊûÑÂª∫ Docker ÈïúÂÉèÂπ∂ÊâìÊ†áÁ≠æ
      - name: Build Docker image
        run: |
          LOWER_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          docker build \
            -t ghcr.io/$LOWER_OWNER/${{ env.IMAGE_NAME }}:latest \
            -t ghcr.io/$LOWER_OWNER/${{ env.IMAGE_NAME }}:${{ env.VERSION_DATE }} \
            -t ghcr.io/$LOWER_OWNER/${{ env.IMAGE_NAME }}:${{ env.VERSION_SHA }} .

      # 5Ô∏è‚É£ Êé®ÈÄÅ Docker ÈïúÂÉè
      - name: Push Docker image
        run: |
          LOWER_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          docker push ghcr.io/$LOWER_OWNER/${{ env.IMAGE_NAME }}:latest
          docker push ghcr.io/$LOWER_OWNER/${{ env.IMAGE_NAME }}:${{ env.VERSION_DATE }}
          docker push ghcr.io/$LOWER_OWNER/${{ env.IMAGE_NAME }}:${{ env.VERSION_SHA }}


