name: Scheduled Docker Build and Push

on:
  #schedule:
   # - cron: '0 3 * * *'  # ÊØèÂ§©ÂáåÊô®3ÁÇπ
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: ro  # üîπ ÈïúÂÉèÂêçÂèòÈáèÔºå‰øÆÊîπËøôÈáåÂç≥ÂèØ

    steps:
      # 1Ô∏è‚É£ Ê£ÄÂá∫‰ª£Á†Å
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ ËÆæÁΩÆÁâàÊú¨Âè∑
      - name: Set image version
        id: vars
        run: |
          DATE_TAG=$(date +'%Y%m%d')
          echo "VERSION=v$DATE_TAG" >> $GITHUB_ENV

      # 3Ô∏è‚É£ ÁôªÂΩï GHCR
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4Ô∏è‚É£ ÊûÑÂª∫ Docker ÈïúÂÉèÂπ∂ÊâìÊ†áÁ≠æ
      - name: Build Docker image
        run: |
          LOWER_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          docker build -t ghcr.io/$LOWER_OWNER/${{ env.IMAGE_NAME }}:latest \
                       -t ghcr.io/$LOWER_OWNER/${{ env.IMAGE_NAME }}:${{ env.VERSION }} .

      # 5Ô∏è‚É£ Êé®ÈÄÅ Docker ÈïúÂÉè
      - name: Push Docker image
        run: |
          LOWER_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          docker push ghcr.io/$LOWER_OWNER/${{ env.IMAGE_NAME }}:latest
          docker push ghcr.io/$LOWER_OWNER/${{ env.IMAGE_NAME }}:${{ env.VERSION }}

      # 6Ô∏è‚É£ ÂÆâÂÖ®ÂºÇÊ≠•Ê∏ÖÁêÜÊóßÈïúÂÉèÔºåÂè™‰øùÁïôÊúÄËøë3‰∏™
      - name: Cleanup old versions
        env:
          REPO: ${{ github.repository_owner }}/{{ env.IMAGE_NAME }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          LOWER_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO=$LOWER_OWNER/${{ env.IMAGE_NAME }}

          echo "Fetching tags..."
          TAGS=$(curl -s -H "Authorization: Bearer $TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://ghcr.io/v2/$REPO/tags/list | jq -r '.tags[]' | grep '^v' | sort -r)

          COUNT=0
          for TAG in $TAGS; do
            COUNT=$((COUNT+1))
            if [ $COUNT -gt 3 ]; then
              echo "Deleting old tag: $TAG"
              
              # Ëé∑Âèñ manifest digest
              DIGEST=$(curl -sI -H "Authorization: Bearer $TOKEN" \
                  -H "Accept: application/vnd.oci.image.manifest.v1+json" \
                  -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
                  https://ghcr.io/v2/$REPO/manifests/$TAG | grep Docker-Content-Digest | awk '{print $2}' | tr -d $'\r')
              
              # ÈáçËØïÊú∫Âà∂ÔºåÊúÄÂ§ö3Ê¨°
              RETRIES=0
              SUCCESS=0
              while [ $RETRIES -lt 3 ]; do
                RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
                  -H "Authorization: Bearer $TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  https://ghcr.io/v2/$REPO/manifests/$DIGEST)
                if [ "$RESPONSE" = "202" ]; then
                  SUCCESS=1
                  echo "Deleted $TAG successfully."
                  break
                else
                  echo "Failed to delete $TAG, retrying..."
                  RETRIES=$((RETRIES+1))
                  sleep 2
                fi
              done
              if [ $SUCCESS -eq 0 ]; then
                echo "Warning: failed to delete $TAG after 3 retries."
              fi
            fi
          done
